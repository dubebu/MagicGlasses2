---
title: "DHIS2 Magic Glasses"
# author: "John Painter"
# date: "12/20/2021"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    # css: my-sass-rules.scss
    theme:
      version: 4
      bootswatch: sandstone
runtime: shiny
---

<!-- For mapping, need to install the GDAL library.  On mac, use homebrew.  On windows ?  -->
<!-- see : https://gitmemory.cn/index.php/repo/r-spatial/sf/issues/1848 -->
<!-- remotes::install_github("r-spatial/sf", configure.args = "--with-gdal-config=/opt/homebrew/opt/gdal/bin/gdal-config --with-sqlite3-lib=/opt/homebrew/opt/sqlite3") -->

```{r setup, include=FALSE}
options(shiny.trace=FALSE)
options(shiny.reactlog=FALSE)
knitr::opts_chunk$set(echo = FALSE)

library(conflicted) # For diagnosing function name conflicts
library(tidyverse)
library(data.table) # for clean install, run from clean session: 
    # remove.packages("data.table")
    # install.packages("data.table", type = "source",
    # repos = "https://Rdatatable.gitlab.io/data.table")
library(shiny)
library(shinyjs)
library(shinydashboard)
library(shinyBS)
library(shinyLP)
library( shinyFiles )
library( rstudioapi )
library(leaflet)
library( progressr )
# library(mapview)
library(RColorBrewer)
library(plotly)

# library( tidyfast )
# library( tidytable )
# library(googleVis)
library( ggrepel )
library(scales)
library( zoo )
library(knitr)
library(rlang)
library(stringi)
library(tidyselect)
library(geojsonsf)
library(geojsonio)
library(jsonlite)
library(httr)
library(curl)
library(assertthat)

library(futile.logger)
# library(utils)
library(DT)
# library(textutils)
library(readxl)
library(openxlsx)
library(anytime)
library(lubridate)
library( tictoc )

library(ipc)
library(future)
library(furrr)
library( purrr )
library(promises)

# library(knitrProgressBar)
# library( progressr )
library(sf)
library(mapview)
library( leaflet )
# library(rmapshaper)

library( tsibble  )
library( fable )
library( fabletools )
library( feasts )
library( fable.prophet )
# library( fable.bsts )

# busy spinner
library(shinybusy)
add_busy_spinner(spin = "fading-circle", position = "bottom-right")

# Avoid naming conflicts for functions found in more than 1 package...
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("last", "dplyr")
conflict_prefer("first", "dplyr")
conflict_prefer("year", "lubridate")
conflict_prefer("month", "lubridate")
conflict_prefer("week", "lubridate")
conflict_prefer("runExample", "shiny")


home = getActiveProject()
cat('\n ## getActiveProject():' , getActiveProject() )
```

```{r sources, include=FALSE}
# Functions ####
source( "data_time_libraries.r")
source( "outlier.r" )
source( "ingest_formula_data.r")
source( 'TS_Modeling_Functions.r')
source( "Summary_TS.R") # new version of summary_ts()
source( 'TS_model_outlier_impute.R') # model_ts()
source( 'Deviation_Expected_Functions.R')
source( 'theme_ppt.R')
source( 'clean_ts.r' )
source( 'DToptions.R')
source( 'model_ts2.r' )
source( 'api_data.r' )
source( 'dqa.r' )
# source( 'API.r' )

Month_Year = function( x ){ yearmonth( zoo::as.yearmon( x , "%Y%m") ) }

options(dplyr.summarise.inform = FALSE)

useShinyjs()   # Set up shinyjs

```

```{css my-css , include = FALSE, eval = TRUE }

# customize flexdashboard titles

.navbar {
  background-color:red;
  border-color:black;
}
.navbar-brand {
color:black!important;
}

# ---

.fluid-row {
  font-size: 5.9vw;
}

.chart-title {
     font-size: 10px;
}

.chart{
    margin: 0px
}

.shiny-input-container{
    margin: 0px
}

.checkbox{
    margin: 0px
}

.selectize-input { 
    font-size: 10pt; 
    font-weight: bold;
    margin: 0 0 0 0;
    white-space: nowrap;
    padding: 5px;
    } 
    
.select-input { 
    font-size: 10pt; 
    font-weight: bold;
    margin: 0 0 0 0;
    white-space: nowrap;
    padding: 5px;
    } 
    
.checkbox-input { 
    margin: 0px
    }

.value-box > .inner {
  padding: 5px;
  padding-left: 5px;
  padding-right: 5px;
}

.value-box .value {
  font-size: 10px;
  font-weight: bold;
  margin: 0 0 0 0;
  white-space: nowrap;
  padding: 0;
}

.value-box .caption {
  font-size: 5px;
}

.section.sidebar {
  position: fixed;
  top: 51px; /* overridden by theme */
  left: 0;
  bottom: 0;
  border-right: 1px solid #e2e2e2;
  background-color: white; /* overridden by theme */
  padding-left: 5px;
  padding-right: 5px;
  visibility: hidden;
}

.section.sidebar form p:first-child {
  margin-top: 5px;
}

.storyboard-nav {
    box-sizing: border-box;
    width: 100% !important; /* This prevents JS transformation on width */
    height: auto; /* This overrides the height */
}

.storyboard-nav .sbnext, .storyboard-nav .sbprev {
    height: auto; /* This overrides the height */
    font-size: 3rem;
}

.storyboard-nav .sbframelist {
    height: auto; /* This overrides the height */
}

.storyboard-nav .sbframelist ul {
    box-sizing: border-box;
    width: 100% !important; /* This prevents JS transformation on width */
    height: auto; /* This overrides the height */
}

.storyboard-nav .sbframelist ul li {
    height: auto; /* This overrides the height */
    width: auto; /* This overrides the width */
}


input[type="number"] {
  max-width: 80%;
}

div.outer {
  position: fixed;
  top: 41px;
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  /*overflow: hidden;*/
  padding: 0;
}

#controls {
  /* Appearance */
  background-color: white;
  padding: 0 10px 10px 10px;
  cursor: move;
  /* Fade out while not hovering */
  opacity: 0.65;
  zoom: 0.9;
  transition: opacity 500ms 1s;
  overflow-y: auto;
}

#controls:hover {
  /* Fade in while hovering */
  opacity: 0.95;
  transition-delay: 0;
}

/* Position and style citation */
#cite {
  position: absolute;
  bottom: 10px;
  left: 10px;
  font-size: 12px;
}

/* If not using map tiles, show a white background */
.leaflet-container {
  background-color: white !important;
}

.tab-content {
  overflow: visible;
}

.selectize-control .selectize-dropdown {
  position: static !important;
}

.select-control .select-dropdown {
  position: static !important;
}

/* Customize fonts */
body, label, input, button, select { 
  font-family: 'Helvetica Neue', Helvetica;
  font-weight: 100;
}

h1, h2 { font-weight: 300; }

h3, h4 { font-weight: 200; }

#controls:hover {
  /* Fade in while hovering */
  opacity: 0.95;
  transition-delay: 0;
}

# flexdashboard in rmarkdown (https://groups.google.com/g/shiny-discuss/c/N5N0PqcBvuY?pli=1)
.chart-wrapper {
  overflow-y: scroll;
}

/* Fix DT / Flexdashboard container cut off */
.chart-stage-flex {
  overflow: scroll !important;
}
```

<!-- Inputs {.sidebar data-width=300} -->
<!-- ==================================== -->

Setup and Logon
=======================

Column
-----------------------------------

```{r, echo = FALSE  }
source( 'directory_widget.r' )
directory_widget_ui( "directory1" )

directory_widget_output = directory_widget_server( "directory1" )

```

Column
-----------------------------------

### Login

```{r, echo = FALSE  }
source( 'login_widget.r' )
login_widget_ui( "login1" )

login_widget_output = login_widget_server( "login1" )

```

Metadata Dictionary
========================

```{r , eval=TRUE}
source( 'metadata_widget.r' )
metadata_widget_ui( "metadata1" )

metadata_widget_output =
  metadata_widget_server( "metadata1" ,
            login_widget_output  =  login_widget_output ,
            directory_widget_output = directory_widget_output 
            )
```


Data Dictionary
========================

Column
-----------------------------------

### Data definitions (formulas)

```{r, echo = FALSE  }
source( 'data_widget.r' )
data_widget_ui( "data1" )

data1_Widget_output = 
  data_widget_server( "data1" , 
                      dataDir = directory_widget_output )

```

Column
-----------------------------------

### Data Elements

```{r, echo = FALSE  }
### Data definitions (formulas)

source( 'formula_widget.r' )

formula_widget_ui( "formula1" )

formula1_Widget_output = 
  formula_widget_server( "formula1" , 
                      metadata_widget_output = metadata_widget_output )

```



Request Data
========================

Column
-----------------------------------

### Data definitions (formulas)

```{r, echo = FALSE  }
source( 'data_widget.r' )
data_widget_ui( "data2" )

data2_Widget_output = 
  data_widget_server( "data2" , 
                      dataDir = directory_widget_output 
                      # , data_request_output = data_request_Output
                      )

```

Column
-----------------------------------

### Request

```{r , eval=TRUE}
source( 'data_request_widget.r' )
data_request_widget_ui( "data_request1" )

data_request_Output =
  data_request_widget_server( "data_request1" ,
            loginDetails  =  loginWidgetOutput ,
            dataDirectory = directory_widget_output ,
            metadata_widget_output = metadata_widget_output , 
            data_widget_output = data2_Widget_output
            )
```

Reporting Rate
========================

```{r  }
source( 'reporting_widget.r' )
reporting_widget_ui( "reporting1" )

reporting_widget_output = 
  reporting_widget_server( "reporting1" ,
                         dataDirectory = directory_widget_output ,
                         metadata_widget_output = metadata_widget_output ,
                         data_widget_output = data2_Widget_output )
```



Outliers and Errors
========================


```{r }
source( 'cleaning_widget.r' )

cleaning_widget_ui( "cleaning1" )

cleaning_widget_output = 
  cleaning_widget_server( "cleaning1" , 
                          directory_widget_output = directory_widget_output ,
                         metadata_widget_output = metadata_widget_output ,
                         data_widget_output = data2_Widget_output ,
                         reporting_widget_output = reporting_widget_output 
                         )
```



Evaluation and Trends
========================

```{r }
source( 'evaluation_widget.r' )
evaluation_widget_ui( "evaluation1" )

evaluation_widget_output = 
  evaluation_widget_server( "evaluation1" ,
                         directory_widget_output = directory_widget_output ,
                         metadata_widget_output = metadata_widget_output ,
                         data_widget_output = data2_Widget_output ,
                         reporting_widget_output = reporting_widget_output )
```

About
========================
```{r, eval= FALSE }
 
# source( 'leaflet_widget.r' )
# leaflet_widget_ui( "leaflet1" )
# leaflet_widget_server( "leaflet1" )             
```

